@startuml SCRUM_13_DescargarArchivo
title "SCRUM-13 - Descargar archivo (backend -> repo cloud)"
actor Usuario as "Usuario / Navegador"
participant "Aplicación Frontend" as Frontend
participant "API Backend\n(Express)" as Backend
participant "FileController" as Controller
participant "FileService" as Service
participant "StorageFactory" as Factory
participant "Repositorio Amazon" as Repo
participant "AWS S3 / Cloud" as S3

Usuario -> Frontend: Pulsar 'Descargar' (id de archivo)
Frontend -> Backend: GET /api/files/:id/download
Backend -> Controller: downloadFile(params.id)
Controller -> Service: downloadFile(archivoId, userId)
note right: Service consulta Archivo y Version en la BD
Service -> Repo: repo.downloadFile(cloudKey)  // si proveedor !== 'local'
Repo -> S3: s3.getObject({Bucket, Key})
S3 --> Repo: bytes del archivo (Body)
Repo --> Service: Buffer
Service --> Controller: { buffer, filename, mimetype }
Controller --> Frontend: stream como attachment (application/octet-stream)
Frontend --> Usuario: El navegador muestra 'Guardar como' / descarga el archivo
@enduml
@startuml SCRUM-13_DescargarArchivo
title SCRUM-13: Descargar archivo

actor Usuario
participant "Plataforma web" as Frontend
participant "Backend / API" as Backend
participant "Storage Provider" as Storage

Usuario -> Frontend: 1. Click "Descargar"
activate Usuario
Usuario -> Frontend: 1. Click "Descargar"
activate Frontend
Frontend -> Backend: 2. GET /storage/:provider/download?fileName=...
activate Backend
Backend -> Storage: 3. Obtener URL pública o signed URL
activate Storage
Storage --> Backend: 4. signed URL
deactivate Storage
Backend --> Frontend: 5. 200 {downloadUrl}
deactivate Backend
Frontend -> Usuario: 6. Iniciar descarga (redirect / abrir URL)
deactivate Frontend
deactivate Usuario
@enduml
