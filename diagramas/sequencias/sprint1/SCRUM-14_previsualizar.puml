@startuml SCRUM_14_Previsualizar
title "SCRUM-14 - Previsualizar archivo (miniatura / preview)"
skinparam monochrome true
actor Usuario as "Usuario / Navegador"
participant "Frontend App" as Frontend
participant "API Backend\n(Express)" as Backend
participant "FileController" as Controller
participant "FileService" as Service
participant "StorageRepository" as Repo
participant "CDN / S3" as Storage
participant "Thumbnail Service / Worker" as Thumb
participant "DB (Postgres)" as DB

Usuario -> Frontend: Click 'Previsualizar' en archivo
Frontend -> Backend: GET /api/files/:id/preview
Backend -> Controller: previewFile(id)
Controller -> Service: getFileInfo(id, userId)
Service -> DB: SELECT archivo, version
DB --> Service: metadata (cloudUrl, mimetype)
Service -> Repo: if preview exists -> get thumbnail URL or buffer
alt Thumbnail exists
    Repo -> Storage: GET thumbnail (Key)
    Storage --> Repo: image bytes / URL
else Thumbnail missing
    Service -> Thumb: enqueue thumbnail generation job (file key)
    Thumb -> Repo: download original -> generate thumbnail -> upload thumbnail to Storage
    Repo --> Thumb: thumbnail URL
    Thumb --> Service: thumbnail URL
end
Service --> Controller: { previewUrl }
Controller --> Frontend: 200 OK (redirect/URL to preview image or inline image bytes)
Frontend -> Usuario: Muestra previsualización en modal (img/pdf viewer)
@enduml
@startuml SCRUM-14_Previsualizar
title SCRUM-14: Previsualizar archivo (y encolar impresión)

actor Usuario
participant "Plataforma web" as Frontend
participant "Backend / API" as Backend
participant "GestorArchivos (Facade)" as Gestor
participant "Storage Provider" as Storage
participant "DB: PRINT_JOBS" as PrintJobsDB

Usuario -> Frontend: 1. Click "Previsualizar"
activate Usuario
activate Frontend
Frontend -> Backend: 2. GET /storage/:provider/preview?fileName=...
activate Backend
Backend -> Gestor: 3. previsualizarArchivo(archivo)
activate Gestor
Gestor -> Storage: 4. Obtener signed URL/stream
activate Storage
Storage --> Gestor: 5. URL/stream
deactivate Storage
Gestor --> Backend: 6. previewUrl
deactivate Gestor
Backend --> Frontend: 7. 200 {previewUrl}
deactivate Backend
Frontend -> Usuario: 8. Abrir iframe/modal con previewUrl

' Acción adicional: usuario desea imprimir
Usuario -> Frontend: 9. Click "Imprimir"
activate Usuario
Frontend -> Backend: 10. POST /storage/:provider/files/:id/print
activate Backend
Backend -> Gestor: 11. imprimirArchivo(archivoId, usuario)
activate Gestor
Gestor -> PrintJobsDB: 12. INSERT PRINT_JOB (estado=queued)
activate PrintJobsDB
PrintJobsDB --> Gestor: 13. jobId
deactivate PrintJobsDB
Gestor --> Backend: 14. jobId
deactivate Gestor
Backend --> Frontend: 15. 202 {jobId}
deactivate Backend
Frontend -> Usuario: 16. Mostrar job encolado (jobId)
deactivate Frontend
deactivate Usuario

@enduml
